name: CI - Backend Docker Build & Health Check

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    branches:
      - main

jobs:
  backend-ci:
    name: Backend CI
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Set up Docker
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      # 3️⃣ Build Docker image
      - name: Build backend Docker image
        run: |
          docker build -t devops-backend:ci ./app

      # 4️⃣ Run container
      - name: Run backend container
        run: |
          docker run -d \
            -p 5000:5000 \
            -e APP_ENV=ci \
            -e APP_VERSION=ci-build \
            -e DB_HOST=localhost \
            devops-backend:ci

      # 5️⃣ Wait for app to start
      - name: Wait for backend to start
        run: sleep 5

      # 6️⃣ Health check
      - name: Health check
        run: |
          curl -f http://localhost:5000/health
